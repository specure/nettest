<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Measurement Servers Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 300px;
        }
        .server-info {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: #f9f9f9;
        }
        .server-name {
            font-weight: bold;
            color: #333;
        }
        .server-details {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .stats {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-panel">
        <h3>Measurement Servers</h3>
        <div id="server-list">
            <div class="loading">Loading servers...</div>
        </div>
        <div class="stats" id="stats"></div>
        <div style="margin-top: 10px; text-align: center;">
            <button onclick="window.open('https://specure.github.io/nettest/servers_map.html', '_blank')" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">
                Open in New Window
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configuration
        const CONTROL_SERVER_URL = 'https://api-beta.nettest.org'; // Change this to your control server URL
        const X_NETTEST_CLIENT = 'nt';
        
        // Try to detect if we're running in an iframe
        const isInIframe = window !== window.top;

        // Initialize map
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let markers = [];
        let servers = [];

        async function fetchServers() {
            try {
                const response = await fetch(`${CONTROL_SERVER_URL}/measurementServer`, {
                    method: 'GET',
                    headers: {
                        'x-nettest-client': X_NETTEST_CLIENT,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const servers = await response.json();
                return servers;
            } catch (error) {
                console.error('Error fetching servers:', error);
                
                // If we're in an iframe and get CORS error, show helpful message
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    throw new Error('Cannot connect to control server. Make sure the server is running and accessible. If viewing in GitHub, you may need to open the map directly in your browser.');
                }
                
                throw error;
            }
        }

        function createServerInfo(server) {
            const div = document.createElement('div');
            div.className = 'server-info';
            
            const name = document.createElement('div');
            name.className = 'server-name';
            name.textContent = server.name;
            
            const details = document.createElement('div');
            details.className = 'server-details';
            details.innerHTML = `
                <div>City: ${server.city}</div>
                <div>Web Address: ${server.webAddress}</div>
                <div>Distance: ${server.distance.toFixed(2)} km</div>
                <div>Version: ${server.version || 'N/A'}</div>
                <div>IPv4: ${server.ipV4Support ? 'Yes' : 'No'}</div>
                <div>IPv6: ${server.ipV6Support ? 'Yes' : 'No'}</div>
                <div>Dedicated: ${server.dedicated ? 'Yes' : 'No'}</div>
            `;
            
            div.appendChild(name);
            div.appendChild(details);
            return div;
        }

        function updateMap(servers) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Filter servers with valid coordinates
            const validServers = servers.filter(server => 
                server.location && 
                server.location.latitude !== 0 && 
                server.location.longitude !== 0 &&
                !isNaN(server.location.latitude) && 
                !isNaN(server.location.longitude)
            );

            if (validServers.length === 0) {
                document.getElementById('server-list').innerHTML = 
                    '<div class="error">No servers with valid coordinates found</div>';
                return;
            }

            // Add markers for each server
            validServers.forEach(server => {
                const marker = L.marker([server.location.latitude, server.location.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <b>${server.name}</b><br>
                        City: ${server.city}<br>
                        Web Address: ${server.webAddress}<br>
                        Distance: ${server.distance.toFixed(2)} km<br>
                        Version: ${server.version || 'N/A'}<br>
                        IPv4: ${server.ipV4Support ? 'Yes' : 'No'}<br>
                        IPv6: ${server.ipV6Support ? 'Yes' : 'No'}<br>
                        Dedicated: ${server.dedicated ? 'Yes' : 'No'}
                    `);
                markers.push(marker);
            });

            // Fit map to show all markers
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }

            // Update server list
            const serverList = document.getElementById('server-list');
            serverList.innerHTML = '';
            validServers.forEach(server => {
                serverList.appendChild(createServerInfo(server));
            });

            // Update stats
            document.getElementById('stats').innerHTML = `
                Total servers: ${servers.length}<br>
                Servers with coordinates: ${validServers.length}<br>
                Average distance: ${(validServers.reduce((sum, s) => sum + s.distance, 0) / validServers.length).toFixed(2)} km
            `;
        }

        async function loadServers() {
            try {
                document.getElementById('server-list').innerHTML = '<div class="loading">Loading servers...</div>';
                const servers = await fetchServers();
                updateMap(servers);
            } catch (error) {
                document.getElementById('server-list').innerHTML = 
                    `<div class="error">Error loading servers: ${error.message}</div>`;
            }
        }

        // Load servers on page load
        loadServers();

        // Refresh every 30 seconds
        setInterval(loadServers, 30000);
    </script>
</body>
</html> 