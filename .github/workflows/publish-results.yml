name: Publish Test Results to Pages

on:
  workflow_run:
    workflows: ["Test on Main Branch"]
    types: [completed]
    branches: [main, test]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download test results
      uses: actions/download-artifact@v4
      with:
        name: test-results-${{ github.event.workflow_run.head_sha }}
        path: artifacts
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Build results database
      run: |
        echo "Building test results database..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
        mkdir -p static/results
        
        # Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ğ±Ğ°Ğ·Ñƒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ¸Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
        if [ -f "static/results/test-results.json" ]; then
          echo "Found existing results database in repository"
          EXISTING_RESULTS=$(cat static/results/test-results.json)
        else
          echo "No existing database, starting fresh"
          EXISTING_RESULTS="[]"
        fi
        
        # Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
        if [ -f "artifacts/test_results.json" ]; then
          echo "Found new test results, updating database..."
          NEW_RESULTS=$(cat artifacts/test_results.json)
          
          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ğ¼Ğ°ÑÑĞ¸Ğ²Ğ°
          UPDATED_RESULTS=$(echo "$EXISTING_RESULTS" | jq --argjson new "$NEW_RESULTS" '[$new] + .')
          
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½ÑƒÑ Ğ±Ğ°Ğ·Ñƒ
          echo "$UPDATED_RESULTS" > static/results/test-results.json
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
          TOTAL_RESULTS=$(echo "$UPDATED_RESULTS" | jq length)
          echo "Database updated successfully"
          echo "Total results in database: $TOTAL_RESULTS"
          
          if [ $TOTAL_RESULTS -gt 0 ]; then
            echo "Latest result:"
            echo "$UPDATED_RESULTS" | jq '.[0] | "\(.timestamp) - Ping: \(.ping)ms, Download: \(.download)Gbps, Upload: \(.upload)Gbps"'
          fi
          
        else
          echo "No new results found, keeping existing database"
          cp static/results/test-results.json static/results/test-results.json
        fi
        
        echo "Results database built successfully"
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ API endpoint Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
        mkdir -p static/api
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ API endpoint
        cat > static/api/test-results << 'EOF'
#!/bin/bash
echo "Content-Type: application/json"
echo "Access-Control-Allow-Origin: *"
echo "Access-Control-Allow-Methods: GET, OPTIONS"
echo "Access-Control-Allow-Headers: Content-Type"
echo ""

if [ "$REQUEST_METHOD" = "OPTIONS" ]; then
    exit 0
fi

if [ -f "../results/test-results.json" ]; then
    cat "../results/test-results.json"
else
    echo "[]"
fi
EOF
        
        chmod +x static/api/test-results
        
        echo "Results database built successfully"
        
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: static
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Update README with latest results
      run: |
        echo "Updating README with latest test results..."
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
        if [ -f "static/results/test-results.json" ]; then
          LATEST_RESULTS=$(cat static/results/test-results.json | jq '.[0]')
          
          if [ "$LATEST_RESULTS" != "null" ]; then
            PING=$(echo "$LATEST_RESULTS" | jq -r '.ping')
            DOWNLOAD=$(echo "$LATEST_RESULTS" | jq -r '.download')
            UPLOAD=$(echo "$LATEST_RESULTS" | jq -r '.upload')
            COMMIT_HASH=$(echo "$LATEST_RESULTS" | jq -r '.commit_hash')
            TIMESTAMP=$(echo "$LATEST_RESULTS" | jq -r '.timestamp')
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ README.md
            if [ -f "README.md" ]; then
              # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ backup
              cp README.md README.md.backup
              
              # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞµĞºÑ†Ğ¸Ñ Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ñ‚ĞµÑÑ‚Ğ¾Ğ²
              sed -i '/## ğŸ§ª Latest Test Results/,/^##/c\
## ğŸ§ª Latest Test Results\
\
**Last Test:** `'"$TIMESTAMP"'`\
**Commit:** [`'"${COMMIT_HASH:0:8}"'`](https://github.com/${{ github.repository }}/commit/'"$COMMIT_HASH"')\
\
| Metric | Value |
|--------|-------|\
| ğŸ¯ Ping | '"$PING"' ms |
| â¬‡ï¸ Download | '"$DOWNLOAD"' Gbps |
| â¬†ï¸ Upload | '"$UPLOAD"' Gbps |\
\
ğŸ“Š [View Full Test History](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/test-results.html)\
' README.md
              
              echo "README updated with latest test results"
            fi
          fi
        fi
