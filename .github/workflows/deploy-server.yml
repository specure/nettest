name: Deploy Nettest Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Debian Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: 172.105.0.231
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸš€ Starting Nettest Server Deployment"
          echo "====================================="
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ URL Ğ´Ğ»Ñ Debian x86_64
          NETTEST_URL="https://github.com/specure/nettest/releases/download/latest/nettest-debian-11-x86_64.tar.gz"
          NEW_BUILD_DIR="/tmp/nettest-new"
          OLD_BUILD_DIR="/tmp/nettest-old"
          CURRENT_BUILD_DIR="/opt/nettest"
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
          mkdir -p $NEW_BUILD_DIR
          mkdir -p $OLD_BUILD_DIR
          
          echo "ğŸ“¦ Downloading latest build..."
          cd $NEW_BUILD_DIR
          wget -q $NETTEST_URL -O nettest.tar.gz
          
          if [ ! -f nettest.tar.gz ]; then
            echo "âŒ Failed to download nettest build"
            exit 1
          fi
          
          echo "ğŸ“¦ Extracting new build..."
          tar -xzf nettest.tar.gz
          
          if [ ! -f nettest ]; then
            echo "âŒ Failed to extract nettest binary"
            exit 1
          fi
          
          echo "ğŸ”§ Setting permissions..."
          chmod +x nettest
          
          echo "ğŸ›‘ Stopping existing nettest process..."
          pkill -f "nettest -s" || echo "No existing nettest process found"
          sleep 2
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ±Ğ¸Ğ»Ğ´
          if [ -d "$CURRENT_BUILD_DIR" ]; then
            echo "ğŸ“¦ Backing up old build..."
            mv $CURRENT_BUILD_DIR $OLD_BUILD_DIR
          fi
          
          echo "ğŸ“¦ Installing new build..."
          mkdir -p $CURRENT_BUILD_DIR
          cp nettest $CURRENT_BUILD_DIR/
          cd $CURRENT_BUILD_DIR
          
          echo "ğŸš€ Starting new nettest server..."
          nohup ./nettest -s > nettest.log 2>&1 &
          NEW_PID=$!
          
          echo "â³ Waiting for server to start..."
          sleep 5
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ»ÑÑ Ğ»Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€
          if ps -p $NEW_PID > /dev/null; then
            echo "âœ… New nettest server started successfully (PID: $NEW_PID)"
            echo "ğŸ“Š Server info:"
            echo "   Process: $(ps -p $NEW_PID -o pid,ppid,cmd --no-headers)"
            echo "   Logs: tail -f $CURRENT_BUILD_DIR/nettest.log"
            
            # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ±Ğ¸Ğ»Ğ´ ĞµÑĞ»Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ»ÑÑ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾
            if [ -d "$OLD_BUILD_DIR" ]; then
              echo "ğŸ—‘ï¸  Removing old build..."
              rm -rf $OLD_BUILD_DIR
            fi
            
            # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
            rm -rf $NEW_BUILD_DIR
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Server is running on port 5005"
            
          else
            echo "âŒ New nettest server failed to start"
            echo "ğŸ“‹ Checking logs..."
            cat $CURRENT_BUILD_DIR/nettest.log || echo "No logs available"
            
            # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ¸Ğ»Ğ´
            echo "ğŸ—‘ï¸  Removing failed new build..."
            rm -rf $CURRENT_BUILD_DIR
            rm -rf $NEW_BUILD_DIR
            
            # Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ±Ğ¸Ğ»Ğ´
            if [ -d "$OLD_BUILD_DIR" ]; then
              echo "ğŸ”„ Restoring old build..."
              mv $OLD_BUILD_DIR $CURRENT_BUILD_DIR
              
              echo "ğŸš€ Starting old nettest server..."
              cd $CURRENT_BUILD_DIR
              nohup ./nettest -s > nettest.log 2>&1 &
              OLD_PID=$!
              
              sleep 3
              if ps -p $OLD_PID > /dev/null; then
                echo "âœ… Old nettest server restored successfully (PID: $OLD_PID)"
              else
                echo "âŒ Failed to restore old server"
                exit 1
              fi
            else
              echo "âŒ No old build to restore"
              exit 1
            fi
          fi
          
          echo "ğŸ“Š Final status:"
          echo "   Active nettest processes:"
          ps aux | grep "nettest -s" | grep -v grep || echo "   No nettest processes found"
          echo "   Port 5005 status:"
          netstat -tuln | grep :5005 || echo "   Port 5005 not listening" 